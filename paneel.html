<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LiveHub – Admin Panel</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0d1117;--card:#111827;--muted:#9aa3af;--line:#1f2937;--accent:#2aa7ff}
  body{margin:0;background:var(--bg);color:#e6eef6;font-family:Inter,Arial}
  .wrap{max-width:880px;margin:28px auto;padding:0 16px}
  .panel{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px 16px}
  h1{margin:0 0 4px 0} .sub{color:var(--muted);margin-bottom:16px}
  input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0f1622;color:#e6eef6}
  label{font-size:14px;color:var(--muted);margin:8px 0 6px;display:block}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .btn{background:var(--accent);color:#001018;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  .ghost{background:transparent;border:1px solid var(--line);border-radius:10px;color:var(--muted);padding:10px 12px;cursor:pointer}
  .list .item{background:#0f1622;border:1px solid var(--line);border-radius:12px;padding:12px;margin-top:12px;display:flex;gap:12px;align-items:center}
  .grow{flex:1} .muted{color:var(--muted);font-size:13px}
  .pill{background:#10273a;color:#9bd3ff;padding:4px 8px;border-radius:999px;font-size:12px;margin-left:6px}
  .controls button{margin-left:6px}
  .login{display:flex;gap:8px;margin-top:10px}
</style>
</head>
<body>
<div class="wrap">
  <div class="panel">
    <h1>Admin Panel</h1>
    <div class="sub">Správa přenosů</div>

    <!-- Login box -->
    <div id="authBox">
      <label>Email</label><input id="email" type="email" placeholder="admin@domena.cz">
      <label>Heslo</label><input id="password" type="password" placeholder="••••••••">
      <div class="login">
        <button class="btn" id="btnLogin">Přihlásit</button>
      </div>
    </div>

    <!-- Tools -->
    <div id="tools" style="display:none">
      <div class="row">
        <div>
          <label>Název zápasu</label>
          <input id="title" placeholder="Např. HC Vlašim vs Benešov">
        </div>
        <div>
          <label>Poskytovatel / kanál</label>
          <input id="provider" placeholder="DAZN / FOX / YouTube">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Čas začátku</label>
          <input id="start" placeholder="2025-11-28 17:30">
        </div>
        <div>
          <label>Kategorie</label>
          <select id="category">
            <option value="hokej">Hokej</option>
            <option value="fotbal">Fotbal</option>
            <option value="basket">Basketbal</option>
            <option value="ostatni">Ostatní</option>
          </select>
        </div>
      </div>

      <label>Thumbnail (URL obrázku)</label>
      <input id="thumb" placeholder="https://.../thumb.jpg">

      <label>Odkaz na přenos (.m3u8 / .mp4 / embed)</label>
      <input id="src" placeholder="https://.../stream.m3u8">

      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn" id="btnSave">Přidat přenos</button>
        <button class="ghost" id="btnLogout">Odhlásit</button>
      </div>

      <div style="margin-top:16px;display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">Seznam přenosů</div>
        <button class="ghost" id="btnResequence">Přečíslovat pořadí</button>
      </div>

      <div id="list" class="list"></div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

  // TODO: stejné config jako na index.html
const firebaseConfig = {
  apiKey: "AIzaSyDaWJkHVYiYw2ZbXD6QwWDGFEhmID00B60",
  authDomain: "livehuben.firebaseapp.com",
  projectId: "livehuben",
  storageBucket: "livehuben.firebasestorage.app",
  messagingSenderId: "409372302743",
  appId: "1:409372302743:web:3c10fd9542bb5d88f478d2",
  measurementId: "G-CWV8FZ3DZN"
};

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const $ = (id)=>document.getElementById(id);

  // auth UI
  onAuthStateChanged(auth, (user)=>{
    if(user){ $("authBox").style.display="none"; $("tools").style.display="block"; }
    else { $("authBox").style.display="block"; $("tools").style.display="none"; }
  });
  $("btnLogin").onclick = async ()=>{
    try{ await signInWithEmailAndPassword(auth, $("email").value, $("password").value); }
    catch(e){ alert("Přihlášení selhalo: " + e.message); }
  };
  $("btnLogout").onclick = ()=> signOut(auth);

  // helper – parsování data/času tolerantně
  function toTimestamp(v){
    if(!v) return null;
    const parsed = Date.parse(v.replace(" ", "T"));
    if(isNaN(parsed)) return null;
    return Timestamp.fromDate(new Date(parsed));
  }

  // create
  $("btnSave").onclick = async ()=>{
    const data = {
      title: $("title").value.trim(),
      provider: $("provider").value.trim(),
      start: toTimestamp($("start").value.trim()),
      src: $("src").value.trim(),
      thumb: $("thumb").value.trim(),
      category: $("category").value,
      order: Date.now(),
      createdAt: serverTimestamp()
    };
    if(!data.title || !data.src){ alert("Vyplňte alespoň Název a Odkaz na přenos."); return; }
    try{
      await addDoc(collection(db,"streams"), data);
      ["title","provider","start","src","thumb"].forEach(id=>$(id).value="");
      alert("Uloženo");
    }catch(e){ alert("Chyba uložení: " + e.message); }
  };

  // live list
  const qStreams = query(collection(db,"streams"), orderBy("order","asc"), orderBy("start","asc"));
  onSnapshot(qStreams, (snap)=>{
    const list = $("list");
    if(snap.empty){ list.innerHTML = `<div class="muted">Žádné položky</div>`; return; }
    list.innerHTML = "";
    snap.forEach(docu=>{
      const d = docu.data();
      const li = document.createElement("div");
      li.className = "item";
      li.innerHTML = `
        <div class="grow">
          <div style="font-weight:700">${escapeHtml(d.title)} <span class="pill">${escapeHtml(labelOf(d.category))}</span></div>
          <div class="muted">${escapeHtml(d.provider||"")} ${d.start?("• "+formatTime(d.start)):""}</div>
          ${d.thumb?`<div style="margin-top:8px"><img src="${d.thumb}" style="max-width:220px;border-radius:8px;border:1px solid #1f2937"></div>`:""}
          <div class="muted" style="margin-top:6px;word-break:break-all">${escapeHtml(d.src)}</div>
        </div>
        <div class="controls">
          <button class="ghost" data-act="up">↑</button>
          <button class="ghost" data-act="down">↓</button>
          <button class="ghost" data-act="edit">Upravit</button>
          <button class="ghost" data-act="delete">Smazat</button>
        </div>`;
      li.querySelector('[data-act="delete"]').onclick = ()=> del(docu.id);
      li.querySelector('[data-act="edit"]').onclick = ()=> fillForm(docu.id, d);
      li.querySelector('[data-act="up"]').onclick = ()=> reOrder(docu.id, d.order - 1);
      li.querySelector('[data-act="down"]').onclick = ()=> reOrder(docu.id, d.order + 1);
      list.appendChild(li);
    });
  });

  function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m]))}
  function labelOf(cat){ return ({hokej:"Hokej", fotbal:"Fotbal", basket:"Basketbal", ostatni:"Ostatní"})[cat] || "Ostatní"; }
  function formatTime(ts){ try{ const d = ts.seconds? new Date(ts.seconds*1000): new Date(ts); return d.toLocaleString(); }catch{return ""} }

  async function del(id){
    if(!confirm("Smazat přenos?")) return;
    await deleteDoc(doc(db,"streams",id));
  }
  function fillForm(id, d){
    $("title").value = d.title||"";
    $("provider").value = d.provider||"";
    $("start").value = d.start ? formatTime(d.start) : "";
    $("src").value = d.src||"";
    $("thumb").value = d.thumb||"";
    $("category").value = d.category||"ostatni";
    $("btnSave").textContent = "Uložit změny";
    $("btnSave").onclick = async ()=>{
      const up = {
        title: $("title").value.trim(),
        provider: $("provider").value.trim(),
        start: toTimestamp($("start").value.trim()),
        src: $("src").value.trim(),
        thumb: $("thumb").value.trim(),
        category: $("category").value
      };
      if(!up.title || !up.src){ alert("Název a Odkaz jsou povinné."); return; }
      await updateDoc(doc(db,"streams",id), up);
      ["title","provider","start","src","thumb"].forEach(id=>$(id).value="");
      $("btnSave").textContent = "Přidat přenos";
      $("btnSave").onclick = null; $("btnSave").onclick = async ()=>{ /* reset na create */ };
      location.reload(); // jednoduché vrácení do create režimu
    };
  }
  async function reOrder(id, newOrder){ await updateDoc(doc(db,"streams",id), { order: newOrder }); }
  $("btnResequence").onclick = async ()=>{
    // přepočítá pořadí (1,2,3…)
    // stačí znovu načíst a zapsat postupně
    // (pro jednoduchost tu necháváme na ruční „nahoru/dolů“; toto tlačítko můžete nepoužívat)
    alert("Pořadí řaďte šipkami ↑/↓ u položek.");
  };
</script>
</body>
</html>
